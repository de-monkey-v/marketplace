---
name: llm-proxy
description: This skill should be used when the user asks about "external LLM teammate", "codex teammate", "gemini teammate", "proxy teammate", "multi-LLM team", "LLM routing", "LLM proxy", "codex proxy", "프록시 팀메이트", "외부 LLM", or wants to use non-Claude models within Agent Teams. Provides patterns for routing work to external CLI-based LLMs through thin proxy teammates.
version: 1.0.0
---

# Multi-LLM Proxy Teammate Framework

This skill provides comprehensive guidance on using external CLI-based LLMs (Codex, Gemini CLI) as backend engines for Agent Teams teammates through a thin proxy pattern.

## Overview

### What is an LLM Proxy Teammate?

An LLM proxy teammate is a lightweight Haiku-based agent that acts as a relay layer, forwarding user requests to external LLM CLI tools (like Codex or Gemini CLI) and returning their responses within the Agent Teams framework.

**Key concept**: The proxy teammate itself does minimal reasoning. It receives a message, constructs a CLI invocation, executes the external LLM, and sends back the result.

### Why Use External LLMs?

**1. Diversity of Perspective**
- Different models excel at different tasks
- Cross-model validation and code review
- Leverage specialized models (e.g., translation, creative writing)

**2. Cost Optimization**
- Route simple tasks to cheaper models
- Reserve Sonnet/Opus for complex reasoning

**3. Specific Capabilities**
- Access to models with unique training (e.g., GPT-4 for code generation)
- Multilingual models optimized for specific languages
- Domain-specific fine-tuned models

### The Thin-Proxy Pattern

**Core principle**: Pure external LLM teammates are impossible because the Agent Teams protocol requires Claude CLI infrastructure. The solution is a minimal Haiku wrapper that acts as a protocol adapter.

```
Thin Proxy = Just enough Claude to bridge the protocol gap
```

**Benefits:**
- Minimal cost (Haiku is cheapest Claude model)
- Simple to implement and debug
- Clear separation of concerns

## Core Architecture

The proxy sits between the coordinator and external LLM CLI tools:

```
Coordinator → [SendMessage] → Haiku Proxy → [bash CLI] → External LLM API
                                    ↓
Coordinator ← [SendMessage] ←──────┘
```

**Proxy responsibilities:** protocol compliance, message parsing, CLI invocation, error handling, output formatting.

**Not proxy responsibilities:** complex reasoning, domain expertise, conversation state.

For the full architecture diagram, protocol details, and CLI invocation patterns, see **`references/proxy-architecture.md`**.

## Provider Catalog

### Primary Providers (Tested)

**1. Codex CLI**
- **Command**: `codex --dangerously-bypass-approvals-and-sandbox "prompt"`
- **Environment**: `OPENAI_API_KEY`
- **Model**: GPT-4 (configurable)
- **Use case**: Code generation, translation, general reasoning

**2. Gemini CLI**
- **Command**: `gemini -p "prompt"`
- **Environment**: `GEMINI_API_KEY`
- **Model**: Gemini Pro
- **Use case**: Research, analysis, multilingual tasks

For installation, configuration, advanced options, and model selection guide, see **`references/provider-catalog.md`**.

## Proxy Teammate Prompt Engineering

The system prompt for the Haiku proxy teammate is critical. It must be precise, stateless, and robust to edge cases.

### System Prompt Template

```markdown
# {Provider} Proxy Teammate

You are a thin proxy relay for the {Provider} CLI tool. Your ONLY job is:

1. **Receive message** from your inbox
2. **Extract the user prompt** from the message content
3. **Construct CLI invocation** with proper shell escaping
4. **Execute** the external LLM CLI
5. **Capture output** (stdout/stderr)
6. **Format result** as markdown with proper attribution
7. **Send result** back to the coordinator via SendMessage

## CLI Invocation Template

Use heredoc for all prompts to avoid shell escaping issues:

```bash
timeout 60s {cli-command} <<'EOF'
{prompt}
EOF
```

## Output Formatting

Format the response as:

```markdown
## {Provider} Response

{cli-output}

---
*Generated by {Provider} via proxy teammate*
```

## Error Handling

If CLI execution fails, capture exit code and stderr, then report:

```markdown
## {Provider} Error

**Exit code**: {code}
**Error**: {stderr}

Please check: API key ({ENV_VAR}), CLI in PATH, prompt validity.
```

## Important Constraints

- **Stateless**: Do not maintain conversation history
- **Single-turn**: One prompt → one response
- **No reasoning**: Do not interpret or modify the prompt
- **Relay only**: Pass through the request unchanged
```

### Statelessness Considerations

**Proxy teammates are stateless** - they do not maintain conversation history.

**Example - Bad (assumes state):**
```
Message 1: "Translate this code to Rust: def fib(n): ..."
Message 2: "Now optimize it"  # ❌ Proxy has no memory of "it"
```

**Example - Good (self-contained):**
```
Message 1: "Translate this code to Rust: def fib(n): ..."
Message 2: "Optimize this Rust code: fn fib(n: u32) -> u32 { ... }"  # ✅
```

## Use Case Patterns

### 1. Code Translation (Proven with Codex)
- **Team**: Coordinator (Opus) + Codex Proxy (Haiku) + Reviewer (Sonnet)
- **Flow**: User → Coordinator → Codex proxy → Translation → Reviewer → User
- **See**: `examples/codex-translator.md`

### 2. Cross-Model Code Review
- **Team**: Coordinator (Sonnet) + Claude Reviewer (Opus) + GPT Reviewer (Haiku+Codex)
- **Flow**: Coordinator broadcasts code → All reviewers respond → Coordinator synthesizes
- **See**: `examples/codex-code-reviewer.md`

### 3. Research and Analysis
- **Team**: Coordinator (Opus) + Claude Research (Sonnet) + GPT Research (Haiku+Codex) + Gemini Research (Haiku+Gemini)
- **Flow**: Parallel research → Each agent provides findings → Coordinator identifies consensus

### 4. Cost Optimization Routing

```
Task complexity → routing decision:

├─ Simple (formatting, basic queries)  → Gemini
├─ Moderate (code review, translation) → Codex/GPT-4 or Claude Haiku
└─ Complex (architecture, deep reasoning) → Claude Opus (no proxy)
```

## Model Selection Guide

| Task Type | Recommended Model | Rationale |
|-----------|------------------|-----------|
| Code generation (Python, JS) | Codex/GPT-4 | Superior code completion training |
| Code generation (Rust, Go) | Claude Opus | Better systems language understanding |
| Translation (human languages) | Gemini | Multilingual optimization |
| Creative writing | Claude Opus | Nuanced, context-aware responses |
| API documentation | Codex/GPT-4 | Better API knowledge base |
| Security review | Claude Opus | Careful, thorough analysis |
| Quick prototypes | Haiku or local | Speed and cost priority |

For cost calculations, latency analysis, and detailed selection rationale, see **`references/provider-catalog.md`**.

## Team Integration

### Team Composition Patterns

**1. Hybrid Team (Claude + External LLMs)**

```json
{
  "name": "translation-team",
  "members": [
    {
      "name": "coordinator",
      "model": "opus",
      "role": "Orchestrate translation workflow, validate quality"
    },
    {
      "name": "codex-translator",
      "model": "haiku",
      "role": "Proxy for Codex CLI - handle code translation"
    },
    {
      "name": "quality-checker",
      "model": "sonnet",
      "role": "Validate translation correctness and idiomatic usage"
    }
  ]
}
```

**2. Cross-Model Validation Team**

```json
{
  "name": "code-review-team",
  "members": [
    {
      "name": "coordinator",
      "model": "sonnet",
      "role": "Aggregate feedback from all reviewers"
    },
    {
      "name": "claude-reviewer",
      "model": "opus",
      "role": "Claude perspective on code quality"
    },
    {
      "name": "gpt-reviewer",
      "model": "haiku",
      "role": "Proxy for GPT-4 - OpenAI perspective"
    },
    {
      "name": "gemini-reviewer",
      "model": "haiku",
      "role": "Proxy for Gemini - Google perspective"
    }
  ]
}
```

### How team-architect Should Compose Teams

When adding proxy teammates:
1. **Identify external LLM use case** - Why is this model better suited?
2. **Design coordinator logic** - Route messages, handle errors, aggregate results
3. **Configure proxy member** - Use Haiku, set timeout, include provider-specific system prompt
4. **Plan error handling** - Fallback to Claude? Retry strategy?
5. **Document setup requirements** - CLI tools, environment variables

## Error Handling

Common error scenarios and handling patterns:

| Error | Cause | Response |
|-------|-------|----------|
| CLI not found (exit 127) | Not installed or not in PATH | Report installation instructions |
| Timeout (exit 124) | API slow or rate limited | Report timeout, suggest retry |
| Non-zero exit | API error, invalid key | Report exit code + stderr |
| Large output | Very long response | Warn + optionally truncate |

For full error handling code, fallback strategies, and retry patterns, see **`references/error-handling.md`**.

## Security

Key security considerations:
- `--dangerously-bypass-approvals-and-sandbox` disables sandboxing - use input validation
- Store API keys in environment variables, never in prompts or config files
- Use heredoc invocation (not string interpolation) to prevent shell injection
- External LLMs see all prompt content - avoid sensitive data

For detailed security guidance, input sanitization code, and when NOT to use the proxy pattern, see **`references/security-best-practices.md`**.

## See Also

### Reference Files
- **`references/proxy-architecture.md`** - Full architecture diagram, message protocol, CLI invocation patterns
- **`references/provider-catalog.md`** - Provider installation, configuration, model selection guide
- **`references/prompt-templates.md`** - Ready-to-use system prompts for Codex, Gemini
- **`references/error-handling.md`** - Error scenarios, fallback strategies, limitations
- **`references/security-best-practices.md`** - Security, API key management, input sanitization

### Example Files
- **`examples/codex-translator.md`** - Proven Korean→English translation via Codex proxy
- **`examples/codex-code-reviewer.md`** - Cross-model code review via Codex proxy

### Related Skills
- **`team-lifecycle`** - Creating and managing teams with proxy members
- **`team-templates`** - Team composition patterns
- **`team-monitoring`** - Debugging proxy teammate issues

### Related Agents
- **`team-architect`** - Designs teams with appropriate proxy members
